<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horse Race</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(16, 40px);
            grid-template-rows: repeat(8, 40px);
            position: relative;
            margin-bottom: 20px;
        }
        .square {
            width: 40px;
            height: 40px;
        }
        .horse {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            position: absolute;
            z-index: 2;
            transition: top 0.5s linear, left 0.5s linear;
        }
        .red-horse { background-color: red; }
        .blue-horse { background-color: blue; }
        .green-horse { background-color: green; }
        .yellow-horse { background-color: yellow; }
        .betting-section, .results-section {
            background: white;
            padding: 20px;
            border: 1px solid black;
            margin-bottom: 10px;
        }
        .betting-item, .results-item {
            margin-bottom: 10px;
        }
        #qrcode {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Horse Race</h1>
    <div id="callNumber">Call Number: <span id="callNumberValue"></span></div>
    <div class="betting-section" id="bettingSection">
        <h3>Bets</h3>
        <div id="bets"></div>
    </div>
    <div id="qrcode"></div>
    <button id="startRaceButton">Start Race</button>
    <div class="results-section" id="resultsSection" style="display:none;">
        <h3>Results</h3>
        <div id="resultMessage"></div>
    </div>

    <script>
        // Function to generate a unique call number
        function generateCallNumber() {
            return Math.floor(1000 + Math.random() * 9000); // Generates a random 4-digit number
        }

        async function callFirebaseFunction(functionName, data) {
            const response = await fetch(`https://us-central1-your-project-id.cloudfunctions.net/${functionName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            return response.json();
        }

        async function fetchBets() {
            const callNumber = document.getElementById('callNumberValue').textContent;
            try {
                const response = await fetch(`https://us-central1-your-project-id.cloudfunctions.net/getResults?callNumber=${callNumber}`);
                const result = await response.json();
                const bets = result.bets || [];
                const betsDiv = document.getElementById('bets');
                betsDiv.innerHTML = '';
                bets.forEach(bet => {
                    const betItem = document.createElement('div');
                    betItem.classList.add('betting-item');
                    betItem.textContent = `${bet.user} bet on ${bet.firstChoice} and ${bet.secondChoice}`;
                    betsDiv.appendChild(betItem);
                });
            } catch (error) {
                console.error('Fetch error: ', error);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const qrcodeContainer = document.getElementById('qrcode');
            const startRaceButton = document.getElementById('startRaceButton');
            const resultsSection = document.getElementById('resultsSection');
            const resultMessage = document.getElementById('resultMessage');
            let callNumber;

            function setupCallNumberAndQRCode() {
                callNumber = generateCallNumber();
                document.getElementById('callNumberValue').textContent = callNumber;
                new QRCode(qrcodeContainer, {
                    text: `https://your-domain.com/bet.html?callNumber=${callNumber}`,
                    width: 128,
                    height: 128,
                });
                console.log(`Game created with call number: ${callNumber}`);
            }

            startRaceButton.addEventListener('click', async () => {
                try {
                    const result = await callFirebaseFunction('pickWinner', { callNumber });

                    if (result.success) {
                        const { firstPlace, secondPlace } = result.results;
                        resultMessage.textContent = `1st place: ${firstPlace}, 2nd place: ${secondPlace}`;
                        resultsSection.style.display = 'block';
                    } else {
                        resultMessage.textContent = 'Failed to pick winner.';
                        resultsSection.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error picking winner:', error);
                    resultMessage.textContent = 'Error picking winner.';
                    resultsSection.style.display = 'block';
                }
            });

            setupCallNumberAndQRCode();

            // Fetch bets every second
            setInterval(fetchBets, 1000);

            // Initial fetch
            fetchBets();
        });
    </script>
</body>
</html>
